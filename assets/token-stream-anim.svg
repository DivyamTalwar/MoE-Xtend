<svg width="1200" height="420" viewBox="0 0 1200 420" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#F8FAFC" />
      <stop offset="45%" stop-color="#E0F2FE" />
      <stop offset="100%" stop-color="#FCE7F3" />
    </linearGradient>
    <linearGradient id="accent" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#06B6D4" />
      <stop offset="50%" stop-color="#8B5CF6" />
      <stop offset="100%" stop-color="#EC4899" />
    </linearGradient>
    <linearGradient id="accent2" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#22D3EE" stop-opacity="0.0" />
      <stop offset="50%" stop-color="#22D3EE" stop-opacity="0.35" />
      <stop offset="100%" stop-color="#22D3EE" stop-opacity="0.0" />
    </linearGradient>
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#CBD5E1" stroke-width="1" />
    </pattern>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="#0B1220" flood-opacity="0.12" />
    </filter>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="b" />
      <feColorMatrix in="b" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.55 0" result="g" />
      <feMerge>
        <feMergeNode in="g" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
  </defs>

  <rect width="1200" height="420" fill="url(#bg)" />
  <rect width="1200" height="420" fill="url(#grid)" opacity="0.22" />

  <text x="60" y="66" fill="#0B1220" font-size="28" font-weight="800" font-family="Space Grotesk, Helvetica, Arial, sans-serif">Token Stream: Decode Loop (KV-aware)</text>
  <text x="60" y="98" fill="#334155" font-size="14" font-family="JetBrains Mono, 'Courier New', monospace">One token per step. Cache reuse keeps per-token latency stable while context grows.</text>
  <rect x="60" y="118" width="1080" height="6" fill="url(#accent)" />

  <!-- main diagram card -->
  <g filter="url(#shadow)">
    <rect x="60" y="140" width="760" height="240" rx="18" fill="#FFFFFF" opacity="0.66" stroke="#0B1220" stroke-width="2" />
  </g>

  <!-- right callouts -->
  <g filter="url(#shadow)">
    <rect x="850" y="140" width="290" height="240" rx="18" fill="#FFFFFF" opacity="0.66" stroke="#0B1220" stroke-width="2" />
    <rect x="850" y="140" width="290" height="6" rx="18" fill="url(#accent)" />
    <text x="872" y="172" fill="#0B1220" font-size="14" font-weight="800" font-family="JetBrains Mono, 'Courier New', monospace">Invariants</text>
    <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" fill="#334155">
      <text x="872" y="198">decode_step(t):</text>
      <text x="872" y="218">1) read KV[0:t]</text>
      <text x="872" y="238">2) attn + MoE</text>
      <text x="872" y="258">3) logits -> sample</text>
      <text x="872" y="278">4) append KV[t]</text>
      <text x="872" y="304">memory ~ O(L * H_kv)</text>
      <text x="872" y="324">time/step ~ O(W) (window)</text>
      <text x="872" y="344">RoPE pos uses absolute t</text>
    </g>
  </g>

  <!-- blocks -->
  <g font-family="JetBrains Mono, 'Courier New', monospace" fill="#0B1220">
    <rect x="92" y="182" width="180" height="66" rx="14" fill="#FFFFFF" opacity="0.8" stroke="#0B1220" stroke-width="2" />
    <rect x="314" y="182" width="240" height="66" rx="14" fill="#FFFFFF" opacity="0.8" stroke="#0B1220" stroke-width="2" />
    <rect x="596" y="182" width="190" height="66" rx="14" fill="#FFFFFF" opacity="0.8" stroke="#0B1220" stroke-width="2" />

    <text x="112" y="212" font-size="13" font-weight="800">KV CACHE</text>
    <text x="334" y="212" font-size="13" font-weight="800">TRANSFORMER BLOCK</text>
    <text x="616" y="212" font-size="13" font-weight="800">SAMPLER</text>

    <g font-size="11" fill="#334155">
      <text x="112" y="236">K,V: [t, H_kv, d]</text>
      <text x="334" y="236">attn + MoE + MLP</text>
      <text x="616" y="236">temp, top-p, min-p</text>
    </g>
  </g>

  <!-- arrows + moving token -->
  <g stroke="#0B1220" stroke-width="2" fill="none" stroke-linecap="round">
    <path d="M272 215 C 292 215, 300 215, 314 215" />
    <path d="M554 215 C 574 215, 582 215, 596 215" />
    <path d="M706 248 C 706 310, 250 310, 250 248" stroke-dasharray="8 10" opacity="0.55" />
  </g>
  <g filter="url(#glow)">
    <circle r="7" fill="#06B6D4">
      <animateMotion path="M272 215 C 292 215, 300 215, 314 215" dur="1.2s" repeatCount="indefinite" />
    </circle>
    <circle r="7" fill="#EC4899">
      <animateMotion path="M554 215 C 574 215, 582 215, 596 215" dur="1.2s" begin="0.35s" repeatCount="indefinite" />
    </circle>
    <circle r="6" fill="#8B5CF6" opacity="0.95">
      <animateMotion path="M706 248 C 706 310, 250 310, 250 248" dur="2.6s" repeatCount="indefinite" />
    </circle>
  </g>

  <!-- token-time sinusoid (spectral intuition) -->
  <path d="M100 320 C 190 280, 290 280, 380 320 S 570 360, 660 320 S 750 280, 800 320" fill="none" stroke="url(#accent)" stroke-width="3" filter="url(#glow)" />
  <path d="M100 338 C 190 378, 290 378, 380 338 S 570 298, 660 338 S 750 378, 800 338" fill="none" stroke="#22D3EE" stroke-width="2" opacity="0.7" stroke-dasharray="3 10">
    <animate attributeName="stroke-dashoffset" values="0;90" dur="2.4s" repeatCount="indefinite" />
  </path>
  <circle r="6" fill="#0B1220" opacity="0.75">
    <animateMotion path="M100 320 C 190 280, 290 280, 380 320 S 570 360, 660 320 S 750 280, 800 320" dur="2.8s" repeatCount="indefinite" />
  </circle>

  <!-- scanlines inside card -->
  <rect x="60" y="140" width="760" height="30" fill="url(#accent2)" opacity="0.35">
    <animate attributeName="y" dur="5.2s" repeatCount="indefinite" values="140;350;140" keyTimes="0;0.5;1" calcMode="spline" keySplines="0.42 0 0.58 1;0.42 0 0.58 1" />
  </rect>

  <!-- FFT-style spectrum bars -->
  <g transform="translate(84, 374)" stroke="#0B1220" stroke-width="1">
    <rect x="0" y="-30" width="18" height="30" fill="#BAE6FD" opacity="0.8">
      <animate attributeName="height" values="20;48;22;36;20" dur="1.2s" repeatCount="indefinite" />
      <animate attributeName="y" values="-20;-48;-22;-36;-20" dur="1.2s" repeatCount="indefinite" />
    </rect>
    <rect x="26" y="-24" width="18" height="24" fill="#DDD6FE" opacity="0.8">
      <animate attributeName="height" values="16;44;20;34;16" dur="1.35s" repeatCount="indefinite" />
      <animate attributeName="y" values="-16;-44;-20;-34;-16" dur="1.35s" repeatCount="indefinite" />
    </rect>
    <rect x="52" y="-34" width="18" height="34" fill="#FBCFE8" opacity="0.8">
      <animate attributeName="height" values="26;54;28;42;26" dur="1.1s" repeatCount="indefinite" />
      <animate attributeName="y" values="-26;-54;-28;-42;-26" dur="1.1s" repeatCount="indefinite" />
    </rect>
    <rect x="78" y="-20" width="18" height="20" fill="#BAE6FD" opacity="0.8">
      <animate attributeName="height" values="14;40;18;30;14" dur="1.5s" repeatCount="indefinite" />
      <animate attributeName="y" values="-14;-40;-18;-30;-14" dur="1.5s" repeatCount="indefinite" />
    </rect>
    <rect x="104" y="-28" width="18" height="28" fill="#DDD6FE" opacity="0.8">
      <animate attributeName="height" values="18;46;22;38;18" dur="1.26s" repeatCount="indefinite" />
      <animate attributeName="y" values="-18;-46;-22;-38;-18" dur="1.26s" repeatCount="indefinite" />
    </rect>
    <rect x="130" y="-18" width="18" height="18" fill="#FBCFE8" opacity="0.8">
      <animate attributeName="height" values="12;36;14;28;12" dur="1.65s" repeatCount="indefinite" />
      <animate attributeName="y" values="-12;-36;-14;-28;-12" dur="1.65s" repeatCount="indefinite" />
    </rect>
    <rect x="156" y="-30" width="18" height="30" fill="#BAE6FD" opacity="0.8">
      <animate attributeName="height" values="18;52;20;40;18" dur="1.18s" repeatCount="indefinite" />
      <animate attributeName="y" values="-18;-52;-20;-40;-18" dur="1.18s" repeatCount="indefinite" />
    </rect>
    <rect x="182" y="-22" width="18" height="22" fill="#DDD6FE" opacity="0.8">
      <animate attributeName="height" values="16;42;18;34;16" dur="1.42s" repeatCount="indefinite" />
      <animate attributeName="y" values="-16;-42;-18;-34;-16" dur="1.42s" repeatCount="indefinite" />
    </rect>
    <rect x="208" y="-34" width="18" height="34" fill="#FBCFE8" opacity="0.8">
      <animate attributeName="height" values="20;56;24;44;20" dur="1.08s" repeatCount="indefinite" />
      <animate attributeName="y" values="-20;-56;-24;-44;-20" dur="1.08s" repeatCount="indefinite" />
    </rect>
    <rect x="234" y="-18" width="18" height="18" fill="#BAE6FD" opacity="0.8">
      <animate attributeName="height" values="12;34;16;26;12" dur="1.7s" repeatCount="indefinite" />
      <animate attributeName="y" values="-12;-34;-16;-26;-12" dur="1.7s" repeatCount="indefinite" />
    </rect>
    <rect x="260" y="-28" width="18" height="28" fill="#DDD6FE" opacity="0.8">
      <animate attributeName="height" values="18;48;20;38;18" dur="1.22s" repeatCount="indefinite" />
      <animate attributeName="y" values="-18;-48;-20;-38;-18" dur="1.22s" repeatCount="indefinite" />
    </rect>
    <rect x="286" y="-20" width="18" height="20" fill="#FBCFE8" opacity="0.8">
      <animate attributeName="height" values="14;40;18;30;14" dur="1.52s" repeatCount="indefinite" />
      <animate attributeName="y" values="-14;-40;-18;-30;-14" dur="1.52s" repeatCount="indefinite" />
    </rect>
    <rect x="312" y="-34" width="18" height="34" fill="#BAE6FD" opacity="0.8">
      <animate attributeName="height" values="22;56;24;44;22" dur="1.06s" repeatCount="indefinite" />
      <animate attributeName="y" values="-22;-56;-24;-44;-22" dur="1.06s" repeatCount="indefinite" />
    </rect>
    <rect x="338" y="-22" width="18" height="22" fill="#DDD6FE" opacity="0.8">
      <animate attributeName="height" values="16;42;18;34;16" dur="1.44s" repeatCount="indefinite" />
      <animate attributeName="y" values="-16;-42;-18;-34;-16" dur="1.44s" repeatCount="indefinite" />
    </rect>
    <rect x="364" y="-30" width="18" height="30" fill="#FBCFE8" opacity="0.8">
      <animate attributeName="height" values="18;52;20;40;18" dur="1.16s" repeatCount="indefinite" />
      <animate attributeName="y" values="-18;-52;-20;-40;-18" dur="1.16s" repeatCount="indefinite" />
    </rect>
    <rect x="390" y="-18" width="18" height="18" fill="#BAE6FD" opacity="0.8">
      <animate attributeName="height" values="12;34;16;26;12" dur="1.68s" repeatCount="indefinite" />
      <animate attributeName="y" values="-12;-34;-16;-26;-12" dur="1.68s" repeatCount="indefinite" />
    </rect>
  </g>

  <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" fill="#334155">
    <text x="84" y="404">spectral hint: moving bars approximate energy as tokens advance (FFT-style)</text>
  </g>
</svg>
