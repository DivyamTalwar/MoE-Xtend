<svg width="1200" height="440" viewBox="0 0 1200 440" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#F8FAFC" />
      <stop offset="45%" stop-color="#E0F2FE" />
      <stop offset="100%" stop-color="#FCE7F3" />
    </linearGradient>
    <linearGradient id="accent" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#06B6D4" />
      <stop offset="50%" stop-color="#8B5CF6" />
      <stop offset="100%" stop-color="#EC4899" />
    </linearGradient>
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#CBD5E1" stroke-width="1" />
    </pattern>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="#0B1220" flood-opacity="0.12" />
    </filter>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="5" result="b" />
      <feColorMatrix in="b" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.6 0" result="g" />
      <feMerge>
        <feMergeNode in="g" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
    <linearGradient id="scan" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0" />
      <stop offset="50%" stop-color="#FFFFFF" stop-opacity="0.35" />
      <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0" />
    </linearGradient>
  </defs>

  <rect width="1200" height="440" fill="url(#bg)" />
  <rect width="1200" height="440" fill="url(#grid)" opacity="0.22" />

  <text x="60" y="66" fill="#0B1220" font-size="30" font-weight="800" font-family="Space Grotesk, Helvetica, Arial, sans-serif">Router Math: Top-k Gating + Stability Terms</text>
  <text x="60" y="98" fill="#334155" font-size="14" font-family="JetBrains Mono, 'Courier New', monospace">Goal: sparse compute (k experts) without collapse, overflow, or training instability.</text>
  <rect x="60" y="118" width="1080" height="6" fill="url(#accent)" />

  <!-- math card -->
  <g filter="url(#shadow)">
    <rect x="60" y="140" width="640" height="270" rx="18" fill="#FFFFFF" opacity="0.66" stroke="#0B1220" stroke-width="2" />
  </g>

  <!-- notes card -->
  <g filter="url(#shadow)">
    <rect x="720" y="140" width="420" height="270" rx="18" fill="#FFFFFF" opacity="0.66" stroke="#0B1220" stroke-width="2" />
    <rect x="720" y="140" width="420" height="6" rx="18" fill="url(#accent)" />
    <text x="742" y="172" fill="#0B1220" font-size="14" font-weight="800" font-family="JetBrains Mono, 'Courier New', monospace">Engineering Notes</text>
    <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" fill="#334155">
      <text x="742" y="198">1) capacity: cap = ceil(c * T / E)</text>
      <text x="742" y="218">2) dispatch: (token, expert) -> slot</text>
      <text x="742" y="238">3) overflow: drop, reroute, or pad</text>
      <text x="742" y="258">4) lb loss: avoid expert collapse</text>
      <text x="742" y="278">5) z-loss: regularize logit scale</text>
      <text x="742" y="300">6) eps: stabilize softmax</text>
      <text x="742" y="322">7) fp16/bf16: watch overflow</text>
      <text x="742" y="344">8) all-reduce: expert parallel sharding</text>
      <text x="742" y="366">9) deterministic: stable topk tie-break</text>
    </g>
  </g>

  <!-- equations -->
  <g font-family="JetBrains Mono, 'Courier New', monospace" fill="#0B1220">
    <text x="82" y="172" font-size="14" font-weight="800">Core</text>

    <g font-size="13" fill="#334155">
      <text x="82" y="198">x_t in R^d</text>
      <text x="82" y="218">W_r in R^(E x d)</text>
      <text x="82" y="238">s = W_r x_t  (scores in R^E)</text>
      <text x="82" y="258">I = topk(s, k)</text>
      <text x="82" y="278">w = softmax(s[I])</text>
      <text x="82" y="298">y = sum_{i in I} w_i * E_i(x_t)</text>
    </g>

    <text x="82" y="332" font-size="14" font-weight="800">Common Stabilizers</text>
    <g font-size="12" fill="#334155">
      <text x="82" y="356">load balance (Switch-style): l_aux ~ E * sum_i (p_i * f_i)</text>
      <text x="82" y="376">z-loss: l_z ~ (logsumexp(s))^2  (keeps logits bounded)</text>
      <text x="82" y="396">capacity: enforce max tokens/expert to bound memory + latency</text>
    </g>
  </g>

  <!-- mini selection viz -->
  <g transform="translate(416, 186)">
    <rect x="0" y="0" width="260" height="192" rx="14" fill="#F1F5F9" stroke="#0B1220" stroke-width="2" />
    <text x="14" y="24" font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" font-weight="800" fill="#0B1220">Top-k picks</text>

    <g stroke="#0B1220" stroke-width="1" opacity="0.35">
      <line x1="44" y1="40" x2="44" y2="176" />
      <line x1="84" y1="40" x2="84" y2="176" />
      <line x1="124" y1="40" x2="124" y2="176" />
      <line x1="164" y1="40" x2="164" y2="176" />
      <line x1="204" y1="40" x2="204" y2="176" />
    </g>

    <g stroke="#0B1220" stroke-width="1">
      <rect x="32" y="110" width="24" height="66" fill="#BAE6FD" opacity="0.9" />
      <rect x="72" y="70" width="24" height="106" fill="#DDD6FE" opacity="0.9" />
      <rect x="112" y="130" width="24" height="46" fill="#BAE6FD" opacity="0.9" />
      <rect x="152" y="56" width="24" height="120" fill="#FBCFE8" opacity="0.9" />
      <rect x="192" y="92" width="24" height="84" fill="#DDD6FE" opacity="0.9" />
    </g>

    <g filter="url(#glow)">
      <rect x="152" y="56" width="24" height="120" fill="url(#accent)" opacity="0.0">
        <animate attributeName="opacity" values="0;0.85;0" dur="2.2s" repeatCount="indefinite" />
      </rect>
      <rect x="72" y="70" width="24" height="106" fill="url(#accent)" opacity="0.0">
        <animate attributeName="opacity" values="0;0.85;0" dur="2.2s" begin="0.35s" repeatCount="indefinite" />
      </rect>
    </g>

    <rect x="0" y="0" width="260" height="28" fill="url(#scan)" opacity="0.22">
      <animate attributeName="y" values="0;164;0" dur="5.0s" repeatCount="indefinite" keyTimes="0;0.5;1" calcMode="spline" keySplines="0.42 0 0.58 1;0.42 0 0.58 1" />
    </rect>

    <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="11" fill="#334155">
      <text x="14" y="188">only selected bars run compute</text>
    </g>
  </g>

  <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" fill="#334155">
    <text x="60" y="434">note: formulas shown are canonical; exact losses/overflow rules vary across MoE implementations.</text>
  </g>
</svg>
