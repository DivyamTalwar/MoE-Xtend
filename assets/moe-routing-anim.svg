<svg width="1200" height="440" viewBox="0 0 1200 440" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#F8FAFC" />
      <stop offset="45%" stop-color="#E0F2FE" />
      <stop offset="100%" stop-color="#FCE7F3" />
    </linearGradient>
    <linearGradient id="accent" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#06B6D4" />
      <stop offset="50%" stop-color="#8B5CF6" />
      <stop offset="100%" stop-color="#EC4899" />
    </linearGradient>
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#CBD5E1" stroke-width="1" />
    </pattern>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="#0B1220" flood-opacity="0.12" />
    </filter>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="5" result="b" />
      <feColorMatrix in="b" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.6 0" result="g" />
      <feMerge>
        <feMergeNode in="g" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
    <linearGradient id="scan" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0" />
      <stop offset="50%" stop-color="#FFFFFF" stop-opacity="0.35" />
      <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0" />
    </linearGradient>
  </defs>

  <rect width="1200" height="440" fill="url(#bg)" />
  <rect width="1200" height="440" fill="url(#grid)" opacity="0.22" />

  <text x="60" y="66" fill="#0B1220" font-size="30" font-weight="800" font-family="Space Grotesk, Helvetica, Arial, sans-serif">MoE Routing: Score -> Top-k -> Dispatch -> Merge</text>
  <text x="60" y="98" fill="#334155" font-size="14" font-family="JetBrains Mono, 'Courier New', monospace">Router logits pick k experts per token. Selected experts run, then outputs are merged by normalized weights.</text>
  <rect x="60" y="118" width="1080" height="6" fill="url(#accent)" />

  <!-- main card -->
  <g filter="url(#shadow)">
    <rect x="60" y="140" width="820" height="270" rx="18" fill="#FFFFFF" opacity="0.66" stroke="#0B1220" stroke-width="2" />
  </g>

  <!-- right math card -->
  <g filter="url(#shadow)">
    <rect x="900" y="140" width="240" height="270" rx="18" fill="#FFFFFF" opacity="0.66" stroke="#0B1220" stroke-width="2" />
    <rect x="900" y="140" width="240" height="6" rx="18" fill="url(#accent)" />
    <text x="922" y="172" fill="#0B1220" font-size="14" font-weight="800" font-family="JetBrains Mono, 'Courier New', monospace">Math</text>
    <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" fill="#334155">
      <text x="922" y="198">s = W_r x_t</text>
      <text x="922" y="218">I = topk(s, k)</text>
      <text x="922" y="238">w = softmax(s[I])</text>
      <text x="922" y="258">y = sum_i w_i E_i(x_t)</text>
      <text x="922" y="292">optional:</text>
      <text x="922" y="312">aux load balance loss</text>
      <text x="922" y="332">capacity factor c</text>
      <text x="922" y="360">goal: stable sparse compute</text>
    </g>
  </g>

  <!-- bar chart (router scores) -->
  <g transform="translate(92, 182)" font-family="JetBrains Mono, 'Courier New', monospace">
    <text x="0" y="0" fill="#0B1220" font-size="13" font-weight="800">1) Router Scores (experts)</text>

    <g transform="translate(0, 18)">
      <rect x="0" y="18" width="360" height="160" rx="12" fill="#F1F5F9" stroke="#0B1220" stroke-width="2" />
      <g stroke="#0B1220" stroke-width="1" opacity="0.35">
        <line x1="30" y1="34" x2="30" y2="164" />
        <line x1="70" y1="34" x2="70" y2="164" />
        <line x1="110" y1="34" x2="110" y2="164" />
        <line x1="150" y1="34" x2="150" y2="164" />
        <line x1="190" y1="34" x2="190" y2="164" />
        <line x1="230" y1="34" x2="230" y2="164" />
        <line x1="270" y1="34" x2="270" y2="164" />
        <line x1="310" y1="34" x2="310" y2="164" />
      </g>

      <g stroke="#0B1220" stroke-width="1">
        <rect x="18" y="92" width="24" height="72" fill="#BAE6FD" opacity="0.9" />
        <rect x="58" y="52" width="24" height="112" fill="#DDD6FE" opacity="0.9" />
        <rect x="98" y="118" width="24" height="46" fill="#BAE6FD" opacity="0.9" />
        <rect x="138" y="42" width="24" height="122" fill="#FBCFE8" opacity="0.9" />
        <rect x="178" y="84" width="24" height="80" fill="#DDD6FE" opacity="0.9" />
        <rect x="218" y="64" width="24" height="100" fill="#BAE6FD" opacity="0.9" />
        <rect x="258" y="108" width="24" height="56" fill="#DDD6FE" opacity="0.9" />
        <rect x="298" y="74" width="24" height="90" fill="#BAE6FD" opacity="0.9" />
      </g>

      <!-- top-k highlight (bars 4 and 2) -->
      <g filter="url(#glow)">
        <rect x="138" y="42" width="24" height="122" fill="url(#accent)" opacity="0.0">
          <animate attributeName="opacity" values="0.0;0.85;0.0" dur="2.2s" repeatCount="indefinite" />
        </rect>
        <rect x="58" y="52" width="24" height="112" fill="url(#accent)" opacity="0.0">
          <animate attributeName="opacity" values="0.0;0.85;0.0" dur="2.2s" begin="0.35s" repeatCount="indefinite" />
        </rect>
      </g>

      <!-- scanning selector line -->
      <rect x="0" y="18" width="26" height="160" fill="url(#accent)" opacity="0.10" filter="url(#glow)">
        <animate attributeName="x" values="0;334;0" dur="3.8s" repeatCount="indefinite" keyTimes="0;0.5;1" calcMode="spline" keySplines="0.42 0 0.58 1;0.42 0 0.58 1" />
      </rect>

      <g fill="#334155" font-size="11">
        <text x="10" y="196">E0</text>
        <text x="50" y="196">E1</text>
        <text x="90" y="196">E2</text>
        <text x="130" y="196">E3</text>
        <text x="170" y="196">E4</text>
        <text x="210" y="196">E5</text>
        <text x="250" y="196">E6</text>
        <text x="290" y="196">E7</text>
      </g>
    </g>
  </g>

  <!-- dispatch + merge -->
  <g transform="translate(480, 182)" font-family="JetBrains Mono, 'Courier New', monospace">
    <text x="0" y="0" fill="#0B1220" font-size="13" font-weight="800">2) Select + Dispatch</text>

    <g transform="translate(0, 18)">
      <rect x="0" y="18" width="372" height="160" rx="12" fill="#F1F5F9" stroke="#0B1220" stroke-width="2" />

      <rect x="22" y="42" width="150" height="46" rx="12" fill="#FFFFFF" opacity="0.9" stroke="#0B1220" stroke-width="2" />
      <rect x="22" y="102" width="150" height="46" rx="12" fill="#FFFFFF" opacity="0.9" stroke="#0B1220" stroke-width="2" />

      <rect x="210" y="72" width="140" height="76" rx="12" fill="#FFFFFF" opacity="0.9" stroke="url(#accent)" stroke-width="3" />

      <text x="36" y="70" fill="#0B1220" font-size="12" font-weight="800">Expert E3</text>
      <text x="36" y="88" fill="#334155" font-size="11">w=0.63</text>

      <text x="36" y="130" fill="#0B1220" font-size="12" font-weight="800">Expert E1</text>
      <text x="36" y="148" fill="#334155" font-size="11">w=0.37</text>

      <text x="224" y="104" fill="#0B1220" font-size="12" font-weight="800">Merge</text>
      <text x="224" y="124" fill="#334155" font-size="11">y = sum w_i E_i(x)</text>

      <g stroke="#0B1220" stroke-width="2" fill="none" stroke-linecap="round">
        <path d="M172 66 C 196 66, 198 76, 210 96" />
        <path d="M172 126 C 196 126, 198 116, 210 112" />
      </g>

      <g filter="url(#glow)">
        <circle r="6" fill="#06B6D4">
          <animateMotion path="M172 66 C 196 66, 198 76, 210 96" dur="1.8s" repeatCount="indefinite" />
        </circle>
        <circle r="6" fill="#EC4899">
          <animateMotion path="M172 126 C 196 126, 198 116, 210 112" dur="1.8s" begin="0.45s" repeatCount="indefinite" />
        </circle>
      </g>

      <rect x="210" y="72" width="140" height="76" rx="12" fill="none" stroke="url(#accent)" stroke-width="3" opacity="0.25">
        <animate attributeName="opacity" values="0.15;0.55;0.15" dur="2.4s" repeatCount="indefinite" />
      </rect>
    </g>
  </g>

  <!-- scanline across main card -->
  <rect x="60" y="140" width="820" height="34" fill="url(#scan)" opacity="0.22">
    <animate attributeName="y" dur="6.2s" repeatCount="indefinite" values="140;376;140" keyTimes="0;0.5;1" calcMode="spline" keySplines="0.42 0 0.58 1;0.42 0 0.58 1" />
  </rect>

  <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" fill="#334155">
    <text x="60" y="434">note: routing is token-local. capacity/lb terms keep experts from collapsing or overflowing.</text>
  </g>
</svg>
