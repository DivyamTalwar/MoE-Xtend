<svg width="1200" height="460" viewBox="0 0 1200 460" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#F8FAFC" />
      <stop offset="45%" stop-color="#E0F2FE" />
      <stop offset="100%" stop-color="#FCE7F3" />
    </linearGradient>
    <linearGradient id="accent" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#06B6D4" />
      <stop offset="50%" stop-color="#8B5CF6" />
      <stop offset="100%" stop-color="#EC4899" />
    </linearGradient>
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#CBD5E1" stroke-width="1" />
    </pattern>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="#0B1220" flood-opacity="0.12" />
    </filter>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="b" />
      <feColorMatrix in="b" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.55 0" result="g" />
      <feMerge>
        <feMergeNode in="g" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
    <linearGradient id="scan" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0" />
      <stop offset="50%" stop-color="#FFFFFF" stop-opacity="0.35" />
      <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0" />
    </linearGradient>
  </defs>

  <rect width="1200" height="460" fill="url(#bg)" />
  <rect width="1200" height="460" fill="url(#grid)" opacity="0.22" />

  <text x="60" y="66" fill="#0B1220" font-size="30" font-weight="800" font-family="Space Grotesk, Helvetica, Arial, sans-serif">Sampling Controls (Deterministic / Research Mode)</text>
  <text x="60" y="98" fill="#334155" font-size="14" font-family="JetBrains Mono, 'Courier New', monospace">Turn raw logits into a stable next-token choice using biasing, temperature, truncation, and penalties.</text>
  <rect x="60" y="118" width="1080" height="6" fill="url(#accent)" />

  <!-- main card -->
  <g filter="url(#shadow)">
    <rect x="60" y="140" width="1080" height="290" rx="18" fill="#FFFFFF" opacity="0.66" stroke="#0B1220" stroke-width="2" />
  </g>

  <!-- pipeline -->
  <g font-family="JetBrains Mono, 'Courier New', monospace" fill="#0B1220">
    <rect x="90" y="182" width="150" height="64" rx="14" fill="#FFFFFF" opacity="0.82" stroke="#0B1220" stroke-width="2" />
    <rect x="260" y="182" width="170" height="64" rx="14" fill="#FFFFFF" opacity="0.82" stroke="#0B1220" stroke-width="2" />
    <rect x="450" y="182" width="170" height="64" rx="14" fill="#FFFFFF" opacity="0.82" stroke="#0B1220" stroke-width="2" />
    <rect x="640" y="182" width="170" height="64" rx="14" fill="#FFFFFF" opacity="0.82" stroke="#0B1220" stroke-width="2" />
    <rect x="830" y="182" width="280" height="64" rx="14" fill="#FFFFFF" opacity="0.86" stroke="url(#accent)" stroke-width="3" />

    <text x="110" y="210" font-size="13" font-weight="800">LOGITS</text>
    <text x="110" y="232" font-size="11" fill="#334155">z in R^V</text>

    <text x="280" y="210" font-size="13" font-weight="800">BIAS + PENALTY</text>
    <text x="280" y="232" font-size="11" fill="#334155">logit_bias, rep_pen</text>

    <text x="470" y="210" font-size="13" font-weight="800">TEMPERATURE</text>
    <text x="470" y="232" font-size="11" fill="#334155">z' = z / T</text>

    <text x="660" y="210" font-size="13" font-weight="800">TRUNCATION</text>
    <text x="660" y="232" font-size="11" fill="#334155">top-k / top-p / min-p</text>

    <text x="850" y="210" font-size="13" font-weight="800">SAMPLE / ARGMAX</text>
    <text x="850" y="232" font-size="11" fill="#334155">return token id + logprobs</text>
  </g>

  <!-- connectors and flowing dots -->
  <g stroke="url(#accent)" stroke-width="4" stroke-linecap="round" fill="none" opacity="0.9">
    <path d="M240 214 C 252 214, 258 214, 260 214" />
    <path d="M430 214 C 442 214, 448 214, 450 214" />
    <path d="M620 214 C 632 214, 638 214, 640 214" />
    <path d="M810 214 C 822 214, 828 214, 830 214" />
  </g>
  <g filter="url(#glow)">
    <circle r="7" fill="#06B6D4"><animateMotion path="M240 214 C 252 214, 258 214, 260 214" dur="0.9s" repeatCount="indefinite" /></circle>
    <circle r="7" fill="#8B5CF6"><animateMotion path="M430 214 C 442 214, 448 214, 450 214" dur="0.9s" begin="0.2s" repeatCount="indefinite" /></circle>
    <circle r="7" fill="#EC4899"><animateMotion path="M620 214 C 632 214, 638 214, 640 214" dur="0.9s" begin="0.4s" repeatCount="indefinite" /></circle>
    <circle r="7" fill="#0B1220" opacity="0.8"><animateMotion path="M810 214 C 822 214, 828 214, 830 214" dur="0.9s" begin="0.6s" repeatCount="indefinite" /></circle>
  </g>

  <!-- truncation chart -->
  <g transform="translate(90, 270)" font-family="JetBrains Mono, 'Courier New', monospace">
    <rect x="0" y="0" width="520" height="140" rx="16" fill="#F1F5F9" stroke="#0B1220" stroke-width="2" />
    <text x="18" y="26" font-size="13" font-weight="800" fill="#0B1220">Truncation Intuition</text>
    <text x="18" y="48" font-size="12" fill="#334155">keep only a safe candidate set before sampling</text>

    <g stroke="#0B1220" stroke-width="1" opacity="0.35">
      <line x1="40" y1="62" x2="40" y2="128" />
      <line x1="80" y1="62" x2="80" y2="128" />
      <line x1="120" y1="62" x2="120" y2="128" />
      <line x1="160" y1="62" x2="160" y2="128" />
      <line x1="200" y1="62" x2="200" y2="128" />
      <line x1="240" y1="62" x2="240" y2="128" />
      <line x1="280" y1="62" x2="280" y2="128" />
      <line x1="320" y1="62" x2="320" y2="128" />
      <line x1="360" y1="62" x2="360" y2="128" />
    </g>

    <g stroke="#0B1220" stroke-width="1">
      <rect x="30" y="94" width="22" height="34" fill="#BAE6FD" opacity="0.9" />
      <rect x="70" y="78" width="22" height="50" fill="#DDD6FE" opacity="0.9" />
      <rect x="110" y="102" width="22" height="26" fill="#BAE6FD" opacity="0.9" />
      <rect x="150" y="70" width="22" height="58" fill="#FBCFE8" opacity="0.9" />
      <rect x="190" y="84" width="22" height="44" fill="#DDD6FE" opacity="0.9" />
      <rect x="230" y="92" width="22" height="36" fill="#BAE6FD" opacity="0.9" />
      <rect x="270" y="110" width="22" height="18" fill="#DDD6FE" opacity="0.9" />
      <rect x="310" y="100" width="22" height="28" fill="#BAE6FD" opacity="0.9" />
      <rect x="350" y="112" width="22" height="16" fill="#DDD6FE" opacity="0.9" />
    </g>

    <!-- moving cutoff line -->
    <g filter="url(#glow)">
      <rect x="210" y="58" width="6" height="78" fill="url(#accent)" opacity="0.85">
        <animate attributeName="x" values="90;360;90" dur="4.2s" repeatCount="indefinite" keyTimes="0;0.5;1" calcMode="spline" keySplines="0.42 0 0.58 1;0.42 0 0.58 1" />
      </rect>
    </g>

    <g font-size="11" fill="#334155">
      <text x="18" y="134">top-k: keep k highest</text>
      <text x="200" y="134">top-p: keep smallest mass &gt;= p</text>
      <text x="390" y="134">min-p: drop tiny probs</text>
    </g>
  </g>

  <!-- formulas card -->
  <g filter="url(#shadow)">
    <rect x="640" y="270" width="470" height="140" rx="16" fill="#FFFFFF" opacity="0.70" stroke="#0B1220" stroke-width="2" />
  </g>
  <rect x="640" y="270" width="470" height="6" rx="16" fill="url(#accent)" opacity="0.9" />
  <g font-family="JetBrains Mono, 'Courier New', monospace" fill="#0B1220">
    <text x="662" y="304" font-size="14" font-weight="800">Core Relations</text>
    <g font-size="12" fill="#334155">
      <text x="662" y="328">p = softmax(z / T)</text>
      <text x="662" y="348">min-p: keep i where p_i &gt;= p_max * min_p</text>
      <text x="662" y="368">rep penalty: z[token] -= penalty * count(token)</text>
      <text x="662" y="388">logprobs: log p_i for analysis + regression tests</text>
    </g>
  </g>

  <!-- scanline -->
  <rect x="60" y="140" width="1080" height="36" fill="url(#scan)" opacity="0.22">
    <animate attributeName="y" dur="6.2s" repeatCount="indefinite" values="140;394;140" keyTimes="0;0.5;1" calcMode="spline" keySplines="0.42 0 0.58 1;0.42 0 0.58 1" />
  </rect>

  <g font-family="JetBrains Mono, 'Courier New', monospace" font-size="12" fill="#334155">
    <text x="60" y="454">determinism checklist: fixed seed, stable topk tie-break, disable non-deterministic kernels, record sampling params.</text>
  </g>
</svg>
